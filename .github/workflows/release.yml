name: ‚öôÔ∏è Auto Release

on:
  pull_request:
    types: [closed]
    branches: [main]

  # Manual trigger
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g. 1.2.3, 1.2.3-beta, 0.1.6-rc.1)'
        required: true
        type: string
      force:
        description: 'Force release even if tag exists'
        required: false
        type: boolean
        default: false

jobs:
  release:
    runs-on: ubuntu-latest
    # Condition for both trigger types
    if: |
      (github.event_name == 'pull_request' &&
       github.event.pull_request.merged == true &&
       github.event.pull_request.head.ref == 'dev') ||
      (github.event_name == 'workflow_dispatch')

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'

      # Version extraction logic
      - name: Determine version
        id: determine_version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            # Version from manual input
            INPUT_VERSION="${{ github.event.inputs.version }}"

            # Format validation
            if ! echo "$INPUT_VERSION" | grep -qP '^v?\d+\.\d+\.\d+(?:-[a-zA-Z0-9\.-]+)?(?:\+[a-zA-Z0-9\.-]+)?$'; then
              echo "‚ùå Invalid version format: '$INPUT_VERSION'"
              echo "üí° Expected: '1.2.3', '1.2.3-beta', '1.2.3-rc.1'"
              exit 1
            fi

            VERSION=$(echo "$INPUT_VERSION" | sed 's/^v//')
            TRIGGER_TYPE="manual"

          else
            # Version from PR title
            PR_TITLE="${{ github.event.pull_request.title }}"
            VERSION=$(echo "$PR_TITLE" | grep -oP 'v?\d+\.\d+\.\d+(?:-[a-zA-Z0-9\.-]+)?(?:\+[a-zA-Z0-9\.-]+)?')

            if [ -z "$VERSION" ]; then
              echo "‚ùå No valid version found in: '$PR_TITLE'"
              echo "üí° Format: 'Release v1.2.3' or 'feat: new feature v1.2.3'"
              exit 1
            fi

            VERSION=$(echo "$VERSION" | sed 's/^v//')
            TRIGGER_TYPE="pr"
          fi

          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "TAG_VERSION=v$VERSION" >> $GITHUB_ENV
          echo "TRIGGER_TYPE=$TRIGGER_TYPE" >> $GITHUB_ENV
          echo "‚úÖ Version: $VERSION (triggered by: $TRIGGER_TYPE)"

      # Conditional tag existence check
      - name: Check if version already exists
        run: |
          if git tag | grep -q "^v${{ env.VERSION }}$"; then
            if [ "${{ github.event.inputs.force }}" == "true" ]; then
              echo "‚ö†Ô∏è Tag v${{ env.VERSION }} exists but force=true, continuing..."
              echo "üóëÔ∏è Deleting existing tag..."
              git tag -d "v${{ env.VERSION }}" || true
              git push --delete origin "v${{ env.VERSION }}" || true
            else
              echo "‚ùå Tag v${{ env.VERSION }} already exists!"
              echo "üí° Use 'force=true' to override or choose a different version"
              exit 1
            fi
          else
            echo "‚úÖ Version v${{ env.VERSION }} is available"
          fi

      # Branch validation for manual trigger
      - name: Validate branch for manual trigger
        if: github.event_name == 'workflow_dispatch'
        run: |
          CURRENT_BRANCH=$(git branch --show-current)
          if [ "$CURRENT_BRANCH" != "main" ]; then
            echo "‚ö†Ô∏è Manual release triggered from '$CURRENT_BRANCH' instead of 'main'"
            echo "üîÑ Switching to main branch..."
            git checkout main
            git pull origin main
          fi

      - name: Install dependencies
        run: pnpm install

      - name: Install changelog tools
        run: pnpm add -D conventional-changelog-cli conventional-changelog-angular

      # Update package.json version
      - name: Update package.json version
        run: |
          echo "üì¶ Updating package.json version to ${{ env.VERSION }}..."
          npm pkg set version="${{ env.VERSION }}"
          echo "‚úÖ package.json updated"

      - name: Generate changelog
        run: |
          if [ ! -f CHANGELOG.md ]; then
            echo "# Changelog" > CHANGELOG.md
            echo "" >> CHANGELOG.md
            echo "All notable changes to this project will be documented in this file." >> CHANGELOG.md
            echo "" >> CHANGELOG.md
          fi

          echo "üìù Generating changelog..."
          npx conventional-changelog -p angular -i CHANGELOG.md -s

      - name: Commit and push changes
        run: |
          git config --local user.name "github-actions[bot]"
          git config --local user.email "github-actions[bot]@users.noreply.github.com"

          # Check for changes in package.json and CHANGELOG.md
          CHANGED_FILES=""

          if ! git diff --quiet package.json; then
            git add package.json
            CHANGED_FILES="package.json"
          fi

          if ! git diff --quiet CHANGELOG.md; then
            git add CHANGELOG.md
            if [ -n "$CHANGED_FILES" ]; then
              CHANGED_FILES="$CHANGED_FILES, CHANGELOG.md"
            else
              CHANGED_FILES="CHANGELOG.md"
            fi
          fi

          if [ -n "$CHANGED_FILES" ]; then
            if [ "${{ env.TRIGGER_TYPE }}" == "manual" ]; then
              COMMIT_MSG="chore(release): v${{ env.VERSION }} [manual release]"
            else
              COMMIT_MSG="chore(release): v${{ env.VERSION }}"
            fi

            git commit -m "$COMMIT_MSG"
            git push origin main
            echo "‚úÖ Changes committed and pushed ($CHANGED_FILES)"
          else
            echo "üìù No changes to commit"
          fi

      - name: Create and push tag
        run: |
          if [ "${{ env.TRIGGER_TYPE }}" == "manual" ]; then
            TAG_MSG="Release version ${{ env.VERSION }} (manual release by ${{ github.actor }})"
          else
            TAG_MSG="Release version ${{ env.VERSION }}"
          fi

          git tag -a "${{ env.TAG_VERSION }}" -m "$TAG_MSG"
          git push origin "${{ env.TAG_VERSION }}"
          echo "üè∑Ô∏è Tag ${{ env.TAG_VERSION }} created and pushed"

      - name: Generate release notes
        run: |
          echo "üìù Generating release notes..."

          # Generate release notes for latest version
          npx conventional-changelog -p angular -r 1 --output-unreleased > latest-changelog.md

          # Add note if manual trigger
          if [ "${{ env.TRIGGER_TYPE }}" == "manual" ]; then
            echo "" >> latest-changelog.md
            echo "---" >> latest-changelog.md
            echo "" >> latest-changelog.md
            echo "üöÄ **Manual release triggered by @${{ github.actor }}**" >> latest-changelog.md
          fi

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.TAG_VERSION }}
          name: "Release ${{ env.TAG_VERSION }}"
          body_path: latest-changelog.md
          draft: false
          prerelease: ${{ contains(env.VERSION, '-') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Merge main into dev
        # Only if we're on main and dev branch exists
        run: |
          if git show-ref --verify --quiet refs/remotes/origin/dev; then
            echo "üîÑ Synchronizing dev branch..."
            git fetch origin dev
            git checkout dev
            git merge main --no-ff -m "chore: sync dev with main after release ${{ env.TAG_VERSION }}"
            git push origin dev
            echo "‚úÖ Dev branch synchronized"
          else
            echo "‚ÑπÔ∏è No dev branch found, skipping sync"
          fi

      # Success notification
      - name: Release summary
        run: |
          echo "üéâ **Release Summary**"
          echo "‚úÖ Version: ${{ env.TAG_VERSION }}"
          echo "‚úÖ Trigger: ${{ env.TRIGGER_TYPE }}"
          echo "‚úÖ Actor: ${{ github.actor }}"
          echo ""
          echo "üîó **Links:**"
          echo "- Release: https://github.com/${{ github.repository }}/releases/tag/${{ env.TAG_VERSION }}"
